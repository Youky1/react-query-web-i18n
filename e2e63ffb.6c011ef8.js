(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{133:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return c})),n.d(t,"toc",(function(){return s})),n.d(t,"default",(function(){return l}));var a=n(3),r=n(7),o=(n(0),n(142)),i={id:"migrating-to-react-query-3",title:"Migrating to React Query 3"},c={unversionedId:"guides&concepts/migrating-to-react-query-3",id:"guides&concepts/migrating-to-react-query-3",isDocsHomePage:!1,title:"Migrating to React Query 3",description:"Previous versions of React Query were awesome and brought some amazing new features, more magic, and an overall better experience to the library. They also brought on massive adoption and likewise a lot of refining fire (issues/contributions) to the library and brought to light a few things that needed more polish to make the library even better. v3 contains that very polish.",source:"@site/docs/guides&concepts/migrating-to-react-query-3.md",slug:"/guides&concepts/migrating-to-react-query-3",permalink:"/react-query-web-i18n/guides&concepts/migrating-to-react-query-3",editUrl:"https://github.com/cangSDARM/react-query-web-i18n/docs/guides&concepts/migrating-to-react-query-3.md",version:"current",lastUpdatedAt:1614595344,sidebar:"zhCN",previous:{title:"Does React Query replace Redux, MobX or other global state managers?",permalink:"/react-query-web-i18n/guides&concepts/does-this-replace-client-state"},next:{title:"Document Template",permalink:"/react-query-web-i18n/doc_template"}},s=[{value:"Overview",id:"overview",children:[]},{value:"Breaking Changes",id:"breaking-changes",children:[{value:"The <code>QueryCache</code> has been split into a <code>QueryClient</code> and lower-level <code>QueryCache</code> and <code>MutationCache</code> instances.",id:"the-querycache-has-been-split-into-a-queryclient-and-lower-level-querycache-and-mutationcache-instances",children:[]},{value:"<code>ReactQueryConfigProvider</code> and <code>ReactQueryCacheProvider</code> have both been replaced by <code>QueryClientProvider</code>",id:"reactqueryconfigprovider-and-reactquerycacheprovider-have-both-been-replaced-by-queryclientprovider",children:[]},{value:"The default <code>QueryCache</code> is gone. <strong>For real this time!</strong>",id:"the-default-querycache-is-gone-for-real-this-time",children:[]},{value:"The deprecated <code>makeQueryCache</code> utility has been removed.",id:"the-deprecated-makequerycache-utility-has-been-removed",children:[]},{value:"<code>QueryCache.prefetchQuery()</code> has been moved to <code>QueryClient.prefetchQuery()</code>",id:"querycacheprefetchquery-has-been-moved-to-queryclientprefetchquery",children:[]},{value:"<code>ReactQueryErrorResetBoundary</code> and <code>QueryCache.resetErrorBoundaries()</code> have been replaced by <code>QueryErrorResetBoundary</code> and <code>useQueryErrorResetBoundary()</code>.",id:"reactqueryerrorresetboundary-and-querycachereseterrorboundaries-have-been-replaced-by-queryerrorresetboundary-and-usequeryerrorresetboundary",children:[]},{value:"<code>QueryCache.getQuery()</code> has been replaced by <code>QueryCache.find()</code>.",id:"querycachegetquery-has-been-replaced-by-querycachefind",children:[]},{value:"<code>QueryCache.getQueries()</code> has been moved to <code>QueryCache.findAll()</code>.",id:"querycachegetqueries-has-been-moved-to-querycachefindall",children:[]},{value:"<code>QueryCache.isFetching</code> has been moved to <code>QueryClient.isFetching()</code>.",id:"querycacheisfetching-has-been-moved-to-queryclientisfetching",children:[]},{value:"The <code>useQueryCache</code> hook has been replaced by the <code>useQueryClient</code> hook.",id:"the-usequerycache-hook-has-been-replaced-by-the-usequeryclient-hook",children:[]},{value:"Query key parts/pieces are no longer automatically spread to the query function.",id:"query-key-partspieces-are-no-longer-automatically-spread-to-the-query-function",children:[]},{value:"Infinite Query Page params are now passed via <code>QueryFunctionContext.pageParam</code>",id:"infinite-query-page-params-are-now-passed-via-queryfunctioncontextpageparam",children:[]},{value:"usePaginatedQuery() has been deprecated in favor of the <code>keepPreviousData</code> option",id:"usepaginatedquery-has-been-deprecated-in-favor-of-the-keeppreviousdata-option",children:[]},{value:"useInfiniteQuery() is now bi-directional",id:"useinfinitequery-is-now-bi-directional",children:[]},{value:"Infinite Query data now contains the array of pages and pageParams used to fetch those pages.",id:"infinite-query-data-now-contains-the-array-of-pages-and-pageparams-used-to-fetch-those-pages",children:[]},{value:"useMutation now returns an object instead of an array",id:"usemutation-now-returns-an-object-instead-of-an-array",children:[]},{value:"<code>mutation.mutate</code> no longer return a promise",id:"mutationmutate-no-longer-return-a-promise",children:[]},{value:"The object syntax for useQuery now uses a collapsed config:",id:"the-object-syntax-for-usequery-now-uses-a-collapsed-config",children:[]},{value:"If set, the QueryOptions.enabled option must be a boolean (<code>true</code>/<code>false</code>)",id:"if-set-the-queryoptionsenabled-option-must-be-a-boolean-truefalse",children:[]},{value:"The QueryOptions.initialStale option has been removed",id:"the-queryoptionsinitialstale-option-has-been-removed",children:[]},{value:"The <code>QueryOptions.forceFetchOnMount</code> option has been replaced by <code>refetchOnMount: &#39;always&#39;</code>",id:"the-queryoptionsforcefetchonmount-option-has-been-replaced-by-refetchonmount-always",children:[]},{value:"The <code>QueryOptions.refetchOnMount</code> options now only applies to its parent component instead of all query observers",id:"the-queryoptionsrefetchonmount-options-now-only-applies-to-its-parent-component-instead-of-all-query-observers",children:[]},{value:"The <code>QueryOptions.queryFnParamsFilter</code> has been removed in favor of the new <code>QueryFunctionContext</code> object.",id:"the-queryoptionsqueryfnparamsfilter-has-been-removed-in-favor-of-the-new-queryfunctioncontext-object",children:[]},{value:"The <code>QueryOptions.notifyOnStatusChange</code> option has been superceded by the new <code>notifyOnChangeProps</code> and <code>notifyOnChangePropsExclusions</code> options.",id:"the-queryoptionsnotifyonstatuschange-option-has-been-superceded-by-the-new-notifyonchangeprops-and-notifyonchangepropsexclusions-options",children:[]},{value:"The <code>QueryResult.clear()</code> function has been renamed to <code>QueryResult.remove()</code>",id:"the-queryresultclear-function-has-been-renamed-to-queryresultremove",children:[]},{value:"The <code>QueryResult.updatedAt</code> property has been split into <code>QueryResult.dataUpdatedAt</code> and <code>QueryResult.errorUpdatedAt</code> properties",id:"the-queryresultupdatedat-property-has-been-split-into-queryresultdataupdatedat-and-queryresulterrorupdatedat-properties",children:[]},{value:"<code>setConsole()</code> has been replaced by the new <code>setLogger()</code> function",id:"setconsole-has-been-replaced-by-the-new-setlogger-function",children:[]},{value:"React Native no longer requires overriding the logger",id:"react-native-no-longer-requires-overriding-the-logger",children:[]}]},{value:"New features",id:"new-features",children:[{value:"Devtools are now part of the main repo and npm package",id:"devtools-are-now-part-of-the-main-repo-and-npm-package",children:[]}]}],u={toc:s};function l(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},u,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"Previous versions of React Query were awesome and brought some amazing new features, more magic, and an overall better experience to the library. They also brought on massive adoption and likewise a lot of refining fire (issues/contributions) to the library and brought to light a few things that needed more polish to make the library even better. v3 contains that very polish."),Object(o.b)("h2",{id:"overview"},"Overview"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"More scalable and testable cache configuration"),Object(o.b)("li",{parentName:"ul"},"Better SSR support"),Object(o.b)("li",{parentName:"ul"},"Data-lag (previously usePaginatedQuery) anywhere!"),Object(o.b)("li",{parentName:"ul"},"Bi-directional Infinite Queries"),Object(o.b)("li",{parentName:"ul"},"Query data selectors!"),Object(o.b)("li",{parentName:"ul"},"Fully configure defaults for queries and/or mutations before use"),Object(o.b)("li",{parentName:"ul"},"More granularity for optional rendering optimization"),Object(o.b)("li",{parentName:"ul"},"New ",Object(o.b)("inlineCode",{parentName:"li"},"useQueries")," hook! (Variable-length parallel query execution)"),Object(o.b)("li",{parentName:"ul"},"Query filter support for the ",Object(o.b)("inlineCode",{parentName:"li"},"useIsFetching()")," hook!"),Object(o.b)("li",{parentName:"ul"},"Retry/offline/replay support for mutations"),Object(o.b)("li",{parentName:"ul"},"Observe queries/mutations outside of React"),Object(o.b)("li",{parentName:"ul"},"Use the React Query core logic anywhere you want!"),Object(o.b)("li",{parentName:"ul"},"Bundled/Colocated Devtools via ",Object(o.b)("inlineCode",{parentName:"li"},"react-query/devtools")),Object(o.b)("li",{parentName:"ul"},"Cache Persistence to localstorage (experimental via ",Object(o.b)("inlineCode",{parentName:"li"},"react-query/persistQueryClient-experimental")," and ",Object(o.b)("inlineCode",{parentName:"li"},"react-query/createLocalStoragePersistor-experimental"),")")),Object(o.b)("h2",{id:"breaking-changes"},"Breaking Changes"),Object(o.b)("h3",{id:"the-querycache-has-been-split-into-a-queryclient-and-lower-level-querycache-and-mutationcache-instances"},"The ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryCache")," has been split into a ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryClient")," and lower-level ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryCache")," and ",Object(o.b)("inlineCode",{parentName:"h3"},"MutationCache")," instances."),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"QueryCache")," contains all queries, the ",Object(o.b)("inlineCode",{parentName:"p"},"MutationCache")," contains all mutations, and the ",Object(o.b)("inlineCode",{parentName:"p"},"QueryClient")," can be used to set configuration and to interact with them."),Object(o.b)("p",null,"This has some benefits:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Allows for different types of caches."),Object(o.b)("li",{parentName:"ul"},"Multiple clients with different configurations can use the same cache."),Object(o.b)("li",{parentName:"ul"},"Clients can be used to track queries, which can be used for shared caches on SSR."),Object(o.b)("li",{parentName:"ul"},"The client API is more focused towards general usage."),Object(o.b)("li",{parentName:"ul"},"Easier to test the individual components.")),Object(o.b)("p",null,"When creating a ",Object(o.b)("inlineCode",{parentName:"p"},"new QueryClient()"),", a ",Object(o.b)("inlineCode",{parentName:"p"},"QueryCache")," and ",Object(o.b)("inlineCode",{parentName:"p"},"MutationCache")," are automatically created for you if you don't supply them."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"import { QueryClient } from 'react-query'\n\nconst queryClient = new QueryClient()\n")),Object(o.b)("h3",{id:"reactqueryconfigprovider-and-reactquerycacheprovider-have-both-been-replaced-by-queryclientprovider"},Object(o.b)("inlineCode",{parentName:"h3"},"ReactQueryConfigProvider")," and ",Object(o.b)("inlineCode",{parentName:"h3"},"ReactQueryCacheProvider")," have both been replaced by ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryClientProvider")),Object(o.b)("p",null,"Default options for queries and mutations can now be specified in ",Object(o.b)("inlineCode",{parentName:"p"},"QueryClient"),":"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      // query options\n    },\n    mutations: {\n      // mutation options\n    },\n  },\n})\n")),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"QueryClientProvider")," component is now used to connect a ",Object(o.b)("inlineCode",{parentName:"p"},"QueryClient")," to your application:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"import { QueryClient, QueryClientProvider } from 'react-query'\n\nconst queryClient = new QueryClient()\n\nfunction App() {\n  return <QueryClientProvider client={queryClient}>...</QueryClientProvider>\n}\n")),Object(o.b)("h3",{id:"the-default-querycache-is-gone-for-real-this-time"},"The default ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryCache")," is gone. ",Object(o.b)("strong",{parentName:"h3"},"For real this time!")),Object(o.b)("p",null,"As previously noted with a deprecation, there is no longer a default ",Object(o.b)("inlineCode",{parentName:"p"},"QueryCache")," that is created or exported from the main package. ",Object(o.b)("strong",{parentName:"p"},"You must create your own via ",Object(o.b)("inlineCode",{parentName:"strong"},"new QueryClient()")," or ",Object(o.b)("inlineCode",{parentName:"strong"},"new QueryCache()")," (which you can then pass to ",Object(o.b)("inlineCode",{parentName:"strong"},"new QueryClient({ queryCache })")," )")),Object(o.b)("h3",{id:"the-deprecated-makequerycache-utility-has-been-removed"},"The deprecated ",Object(o.b)("inlineCode",{parentName:"h3"},"makeQueryCache")," utility has been removed."),Object(o.b)("p",null,"It's been a long time coming, but it's finally gone :)"),Object(o.b)("h3",{id:"querycacheprefetchquery-has-been-moved-to-queryclientprefetchquery"},Object(o.b)("inlineCode",{parentName:"h3"},"QueryCache.prefetchQuery()")," has been moved to ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryClient.prefetchQuery()")),Object(o.b)("p",null,"The new ",Object(o.b)("inlineCode",{parentName:"p"},"QueryClient.prefetchQuery()")," function is async, but ",Object(o.b)("strong",{parentName:"p"},"does not return the data from the query"),". If you require the data, use the new ",Object(o.b)("inlineCode",{parentName:"p"},"QueryClient.fetchQuery()")," function"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"// Prefetch a query:\nawait queryClient.prefetchQuery('posts', fetchPosts)\n\n// Fetch a query:\ntry {\n  const data = await queryClient.fetchQuery('posts', fetchPosts)\n} catch (error) {\n  // Error handling\n}\n")),Object(o.b)("h3",{id:"reactqueryerrorresetboundary-and-querycachereseterrorboundaries-have-been-replaced-by-queryerrorresetboundary-and-usequeryerrorresetboundary"},Object(o.b)("inlineCode",{parentName:"h3"},"ReactQueryErrorResetBoundary")," and ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryCache.resetErrorBoundaries()")," have been replaced by ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryErrorResetBoundary")," and ",Object(o.b)("inlineCode",{parentName:"h3"},"useQueryErrorResetBoundary()"),"."),Object(o.b)("p",null,"Together, these provide the same experience as before, but with added control to choose which component trees you want to reset. For more information, see:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",{parentName:"li",href:"../reference/QueryErrorResetBoundary"},"QueryErrorResetBoundary")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",{parentName:"li",href:"../reference/useQueryErrorResetBoundary"},"useQueryErrorResetBoundary"))),Object(o.b)("h3",{id:"querycachegetquery-has-been-replaced-by-querycachefind"},Object(o.b)("inlineCode",{parentName:"h3"},"QueryCache.getQuery()")," has been replaced by ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryCache.find()"),"."),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"QueryCache.find()")," should now be used to look up individual queries from a cache"),Object(o.b)("h3",{id:"querycachegetqueries-has-been-moved-to-querycachefindall"},Object(o.b)("inlineCode",{parentName:"h3"},"QueryCache.getQueries()")," has been moved to ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryCache.findAll()"),"."),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"QueryCache.findAll()")," should now be used to look up multiple queries from a cache"),Object(o.b)("h3",{id:"querycacheisfetching-has-been-moved-to-queryclientisfetching"},Object(o.b)("inlineCode",{parentName:"h3"},"QueryCache.isFetching")," has been moved to ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryClient.isFetching()"),"."),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"Notice that it's now a function instead of a property")),Object(o.b)("h3",{id:"the-usequerycache-hook-has-been-replaced-by-the-usequeryclient-hook"},"The ",Object(o.b)("inlineCode",{parentName:"h3"},"useQueryCache")," hook has been replaced by the ",Object(o.b)("inlineCode",{parentName:"h3"},"useQueryClient")," hook."),Object(o.b)("p",null,"It returns the provided ",Object(o.b)("inlineCode",{parentName:"p"},"queryClient")," for its component tree and shouldn't need much tweaking beyond a rename."),Object(o.b)("h3",{id:"query-key-partspieces-are-no-longer-automatically-spread-to-the-query-function"},"Query key parts/pieces are no longer automatically spread to the query function."),Object(o.b)("p",null,"Inline functions are now the suggested way of passing parameters to your query functions:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"// Old\nuseQuery(['post', id], (_key, id) => fetchPost(id))\n\n// New\nuseQuery(['post', id], () => fetchPost(id))\n")),Object(o.b)("p",null,"If you still insist on not using inline functions, you can use the newly passed ",Object(o.b)("inlineCode",{parentName:"p"},"QueryFunctionContext"),":"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"useQuery(['post', id], context => fetchPost(context.queryKey[1]))\n")),Object(o.b)("h3",{id:"infinite-query-page-params-are-now-passed-via-queryfunctioncontextpageparam"},"Infinite Query Page params are now passed via ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryFunctionContext.pageParam")),Object(o.b)("p",null,"They were previously added as the last query key parameter in your query function, but this proved to be difficult for some patterns"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"// Old\nuseInfiniteQuery(['posts'], (_key, pageParam = 0) => fetchPosts(pageParam))\n\n// New\nuseInfiniteQuery(['posts'], ({ pageParam = 0 }) => fetchPost(pageParam))\n")),Object(o.b)("h3",{id:"usepaginatedquery-has-been-deprecated-in-favor-of-the-keeppreviousdata-option"},"usePaginatedQuery() has been deprecated in favor of the ",Object(o.b)("inlineCode",{parentName:"h3"},"keepPreviousData")," option"),Object(o.b)("p",null,"The new ",Object(o.b)("inlineCode",{parentName:"p"},"keepPreviousData")," options is available for both ",Object(o.b)("inlineCode",{parentName:"p"},"useQuery")," and ",Object(o.b)("inlineCode",{parentName:"p"},"useInfiniteQuery"),' and will have the same "lagging" effect on your data:'),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"import { useQuery } from 'react-query'\n\nfunction Page({ page }) {\n  const { data } = useQuery(['page', page], fetchPage, {\n    keepPreviousData: true,\n  })\n}\n")),Object(o.b)("h3",{id:"useinfinitequery-is-now-bi-directional"},"useInfiniteQuery() is now bi-directional"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"useInfiniteQuery()")," interface has changed to fully support bi-directional infinite lists."),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("inlineCode",{parentName:"li"},"options.getFetchMore")," has been renamed to ",Object(o.b)("inlineCode",{parentName:"li"},"options.getNextPageParam")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("inlineCode",{parentName:"li"},"queryResult.canFetchMore")," has been renamed to ",Object(o.b)("inlineCode",{parentName:"li"},"queryResult.hasNextPage")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("inlineCode",{parentName:"li"},"queryResult.fetchMore")," has been renamed to ",Object(o.b)("inlineCode",{parentName:"li"},"queryResult.fetchNextPage")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("inlineCode",{parentName:"li"},"queryResult.isFetchingMore")," has been renamed to ",Object(o.b)("inlineCode",{parentName:"li"},"queryResult.isFetchingNextPage")),Object(o.b)("li",{parentName:"ul"},"Added the ",Object(o.b)("inlineCode",{parentName:"li"},"options.getPreviousPageParam")," option"),Object(o.b)("li",{parentName:"ul"},"Added the ",Object(o.b)("inlineCode",{parentName:"li"},"queryResult.hasPreviousPage")," property"),Object(o.b)("li",{parentName:"ul"},"Added the ",Object(o.b)("inlineCode",{parentName:"li"},"queryResult.fetchPreviousPage")," property"),Object(o.b)("li",{parentName:"ul"},"Added the ",Object(o.b)("inlineCode",{parentName:"li"},"queryResult.isFetchingPreviousPage")),Object(o.b)("li",{parentName:"ul"},"The ",Object(o.b)("inlineCode",{parentName:"li"},"data")," of an infinite query is now an object containing the ",Object(o.b)("inlineCode",{parentName:"li"},"pages")," and the ",Object(o.b)("inlineCode",{parentName:"li"},"pageParams")," used to fetch the pages: ",Object(o.b)("inlineCode",{parentName:"li"},"{ pages: [data, data, data], pageParams: [...]}"))),Object(o.b)("p",null,"One direction:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"const {\n  data,\n  fetchNextPage,\n  hasNextPage,\n  isFetchingNextPage,\n} = useInfiniteQuery(\n  'projects',\n  ({ pageParam = 0 }) => fetchProjects(pageParam),\n  {\n    getNextPageParam: (lastPage, pages) => lastPage.nextCursor,\n  }\n)\n")),Object(o.b)("p",null,"Both directions:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"const {\n  data,\n  fetchNextPage,\n  fetchPreviousPage,\n  hasNextPage,\n  hasPreviousPage,\n  isFetchingNextPage,\n  isFetchingPreviousPage,\n} = useInfiniteQuery(\n  'projects',\n  ({ pageParam = 0 }) => fetchProjects(pageParam),\n  {\n    getNextPageParam: (lastPage, pages) => lastPage.nextCursor,\n    getPreviousPageParam: (firstPage, pages) => firstPage.prevCursor,\n  }\n)\n")),Object(o.b)("p",null,"One direction reversed:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"const {\n  data,\n  fetchNextPage,\n  hasNextPage,\n  isFetchingNextPage,\n} = useInfiniteQuery(\n  'projects',\n  ({ pageParam = 0 }) => fetchProjects(pageParam),\n  {\n    select: data => ({\n      pages: [...data.pages].reverse(),\n      pageParams: [...data.pageParams].reverse(),\n    }),\n    getNextPageParam: (lastPage, pages) => lastPage.nextCursor,\n  }\n)\n")),Object(o.b)("h3",{id:"infinite-query-data-now-contains-the-array-of-pages-and-pageparams-used-to-fetch-those-pages"},"Infinite Query data now contains the array of pages and pageParams used to fetch those pages."),Object(o.b)("p",null,"This allows for easier manipulation of the data and the page params, like, for example, removing the first page of data along with it's params:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"queryClient.setQueryData('projects', data => ({\n  pages: data.pages.slice(1),\n  pageParams: data.pageParams.slice(1),\n}))\n")),Object(o.b)("h3",{id:"usemutation-now-returns-an-object-instead-of-an-array"},"useMutation now returns an object instead of an array"),Object(o.b)("p",null,"Though the old way gave us warm fuzzy feelings of when we first discovered ",Object(o.b)("inlineCode",{parentName:"p"},"useState")," for the first time, they didn't last long. Now the mutation return is a single object."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"// Old:\nconst [mutate, { status, reset }] = useMutation()\n\n// New:\nconst { mutate, status, reset } = useMutation()\n")),Object(o.b)("h3",{id:"mutationmutate-no-longer-return-a-promise"},Object(o.b)("inlineCode",{parentName:"h3"},"mutation.mutate")," no longer return a promise"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"The ",Object(o.b)("inlineCode",{parentName:"li"},"[mutate]")," variable has been changed to the ",Object(o.b)("inlineCode",{parentName:"li"},"mutation.mutate")," function"),Object(o.b)("li",{parentName:"ul"},"Added the ",Object(o.b)("inlineCode",{parentName:"li"},"mutation.mutateAsync")," function")),Object(o.b)("p",null,"We got a lot of questions regarding this behavior as users expected the promise to behave like a regular promise."),Object(o.b)("p",null,"Because of this the ",Object(o.b)("inlineCode",{parentName:"p"},"mutate")," function is now split into a ",Object(o.b)("inlineCode",{parentName:"p"},"mutate")," and ",Object(o.b)("inlineCode",{parentName:"p"},"mutateAsync")," function."),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"mutate")," function can be used when using callbacks:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"const { mutate } = useMutation(addTodo)\n\nmutate('todo', {\n  onSuccess: data => {\n    console.log(data)\n  },\n  onError: error => {\n    console.error(error)\n  },\n  onSettled: () => {\n    console.log('settled')\n  },\n})\n")),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"mutateAsync")," function can be used when using async/await:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"const { mutateAsync } = useMutation(addTodo)\n\ntry {\n  const data = await mutateAsync('todo')\n  console.log(data)\n} catch (error) {\n  console.error(error)\n} finally {\n  console.log('settled')\n}\n")),Object(o.b)("h3",{id:"the-object-syntax-for-usequery-now-uses-a-collapsed-config"},"The object syntax for useQuery now uses a collapsed config:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"// Old:\nuseQuery({\n  queryKey: 'posts',\n  queryFn: fetchPosts,\n  config: { staleTime: Infinity },\n})\n\n// New:\nuseQuery({\n  queryKey: 'posts',\n  queryFn: fetchPosts,\n  staleTime: Infinity,\n})\n")),Object(o.b)("h3",{id:"if-set-the-queryoptionsenabled-option-must-be-a-boolean-truefalse"},"If set, the QueryOptions.enabled option must be a boolean (",Object(o.b)("inlineCode",{parentName:"h3"},"true"),"/",Object(o.b)("inlineCode",{parentName:"h3"},"false"),")"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"enabled")," query option will now only disable a query when the value is ",Object(o.b)("inlineCode",{parentName:"p"},"false"),".\nIf needed, values can be casted with ",Object(o.b)("inlineCode",{parentName:"p"},"!!userId")," or ",Object(o.b)("inlineCode",{parentName:"p"},"Boolean(userId)")," and a handy error will be thrown if a non-boolean value is passed."),Object(o.b)("h3",{id:"the-queryoptionsinitialstale-option-has-been-removed"},"The QueryOptions.initialStale option has been removed"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"initialStale")," query option has been removed and initial data is now treated as regular data.\nWhich means that if ",Object(o.b)("inlineCode",{parentName:"p"},"initialData")," is provided, the query will refetch on mount by default.\nIf you do not want to refetch immediately, you can define a ",Object(o.b)("inlineCode",{parentName:"p"},"staleTime"),"."),Object(o.b)("h3",{id:"the-queryoptionsforcefetchonmount-option-has-been-replaced-by-refetchonmount-always"},"The ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryOptions.forceFetchOnMount")," option has been replaced by ",Object(o.b)("inlineCode",{parentName:"h3"},"refetchOnMount: 'always'")),Object(o.b)("p",null,"Honestly, we were acruing way too many ",Object(o.b)("inlineCode",{parentName:"p"},"refetchOn____")," options, so this should clean things up."),Object(o.b)("h3",{id:"the-queryoptionsrefetchonmount-options-now-only-applies-to-its-parent-component-instead-of-all-query-observers"},"The ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryOptions.refetchOnMount")," options now only applies to its parent component instead of all query observers"),Object(o.b)("p",null,"When ",Object(o.b)("inlineCode",{parentName:"p"},"refetchOnMount")," was set to ",Object(o.b)("inlineCode",{parentName:"p"},"false")," any additional components were prevented from refetching on mount.\nIn version 3 only the component where the option has been set will not refetch on mount."),Object(o.b)("h3",{id:"the-queryoptionsqueryfnparamsfilter-has-been-removed-in-favor-of-the-new-queryfunctioncontext-object"},"The ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryOptions.queryFnParamsFilter")," has been removed in favor of the new ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryFunctionContext")," object."),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"queryFnParamsFilter")," option has been removed because query functions now get a ",Object(o.b)("inlineCode",{parentName:"p"},"QueryFunctionContext")," object instead of the query key."),Object(o.b)("p",null,"Parameters can still be filtered within the query function itself as the ",Object(o.b)("inlineCode",{parentName:"p"},"QueryFunctionContext")," also contains the query key."),Object(o.b)("h3",{id:"the-queryoptionsnotifyonstatuschange-option-has-been-superceded-by-the-new-notifyonchangeprops-and-notifyonchangepropsexclusions-options"},"The ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryOptions.notifyOnStatusChange")," option has been superceded by the new ",Object(o.b)("inlineCode",{parentName:"h3"},"notifyOnChangeProps")," and ",Object(o.b)("inlineCode",{parentName:"h3"},"notifyOnChangePropsExclusions")," options."),Object(o.b)("p",null,"With these new options it is possible to configure when a component should re-render on a granular level."),Object(o.b)("p",null,"Only re-render when the ",Object(o.b)("inlineCode",{parentName:"p"},"data")," or ",Object(o.b)("inlineCode",{parentName:"p"},"error")," properties change:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"import { useQuery } from 'react-query'\n\nfunction User() {\n  const { data } = useQuery('user', fetchUser, {\n    notifyOnChangeProps: ['data', 'error'],\n  })\n  return <div>Username: {data.username}</div>\n}\n")),Object(o.b)("p",null,"Prevent re-render when the ",Object(o.b)("inlineCode",{parentName:"p"},"isStale")," property changes:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"import { useQuery } from 'react-query'\n\nfunction User() {\n  const { data } = useQuery('user', fetchUser, {\n    notifyOnChangePropsExclusions: ['isStale'],\n  })\n  return <div>Username: {data.username}</div>\n}\n")),Object(o.b)("h3",{id:"the-queryresultclear-function-has-been-renamed-to-queryresultremove"},"The ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryResult.clear()")," function has been renamed to ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryResult.remove()")),Object(o.b)("p",null,"Although it was called ",Object(o.b)("inlineCode",{parentName:"p"},"clear"),", it really just removed the query from the cache. The name now matches the functionality."),Object(o.b)("h3",{id:"the-queryresultupdatedat-property-has-been-split-into-queryresultdataupdatedat-and-queryresulterrorupdatedat-properties"},"The ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryResult.updatedAt")," property has been split into ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryResult.dataUpdatedAt")," and ",Object(o.b)("inlineCode",{parentName:"h3"},"QueryResult.errorUpdatedAt")," properties"),Object(o.b)("p",null,"Because data and errors can be present at the same time, the ",Object(o.b)("inlineCode",{parentName:"p"},"updatedAt")," property has been split into ",Object(o.b)("inlineCode",{parentName:"p"},"dataUpdatedAt")," and ",Object(o.b)("inlineCode",{parentName:"p"},"errorUpdatedAt"),"."),Object(o.b)("h3",{id:"setconsole-has-been-replaced-by-the-new-setlogger-function"},Object(o.b)("inlineCode",{parentName:"h3"},"setConsole()")," has been replaced by the new ",Object(o.b)("inlineCode",{parentName:"h3"},"setLogger()")," function"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"import { setLogger } from 'react-query'\n\n// Log with Sentry\nsetLogger({\n  error: error => {\n    Sentry.captureException(error)\n  },\n})\n\n// Log with Winston\nsetLogger(winston.createLogger())\n")),Object(o.b)("h3",{id:"react-native-no-longer-requires-overriding-the-logger"},"React Native no longer requires overriding the logger"),Object(o.b)("p",null,"To prevent showing error screens in React Native when a query fails it was necessary to manually change the Console:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"import { setConsole } from 'react-query'\n\nsetConsole({\n  log: console.log,\n  warn: console.warn,\n  error: console.warn,\n})\n")),Object(o.b)("p",null,"In version 3 ",Object(o.b)("strong",{parentName:"p"},"this is done automatically when React Query is used in React Native"),"."),Object(o.b)("h2",{id:"new-features"},"New features"),Object(o.b)("h4",{id:"query-data-selectors"},"Query Data Selectors"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"useQuery")," and ",Object(o.b)("inlineCode",{parentName:"p"},"useInfiniteQuery")," hooks now have a ",Object(o.b)("inlineCode",{parentName:"p"},"select")," option to select or transform parts of the query result."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"import { useQuery } from 'react-query'\n\nfunction User() {\n  const { data } = useQuery('user', fetchUser, {\n    select: user => user.username,\n  })\n  return <div>Username: {data}</div>\n}\n")),Object(o.b)("p",null,"Set the ",Object(o.b)("inlineCode",{parentName:"p"},"notifyOnChangeProps")," option to ",Object(o.b)("inlineCode",{parentName:"p"},"['data', 'error']")," to only re-render when the selected data changes."),Object(o.b)("h4",{id:"the-usequeries-hook-for-variable-length-parallel-query-execution"},"The useQueries() hook, for variable-length parallel query execution"),Object(o.b)("p",null,"Wish you could run ",Object(o.b)("inlineCode",{parentName:"p"},"useQuery")," in a loop? The rules of hooks say no, but with the new ",Object(o.b)("inlineCode",{parentName:"p"},"useQueries()")," hook, you can!"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"import { useQueries } from 'react-query'\n\nfunction Overview() {\n  const results = useQueries([\n    { queryKey: ['post', 1], queryFn: fetchPost },\n    { queryKey: ['post', 2], queryFn: fetchPost },\n  ])\n  return (\n    <ul>\n      {results.map(({ data }) => data && <li key={data.id}>{data.title})</li>)}\n    </ul>\n  )\n}\n")),Object(o.b)("h4",{id:"retryoffline-mutations"},"Retry/offline mutations"),Object(o.b)("p",null,"By default React Query will not retry a mutation on error, but it is possible with the ",Object(o.b)("inlineCode",{parentName:"p"},"retry")," option:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"const mutation = useMutation(addTodo, {\n  retry: 3,\n})\n")),Object(o.b)("p",null,"If mutations fail because the device is offline, they will be retried in the same order when the device reconnects."),Object(o.b)("h4",{id:"persist-mutations"},"Persist mutations"),Object(o.b)("p",null,"Mutations can now be persisted to storage and resumed at a later point. More information can be found in the mutations documentation."),Object(o.b)("h4",{id:"queryobserver"},"QueryObserver"),Object(o.b)("p",null,"A ",Object(o.b)("inlineCode",{parentName:"p"},"QueryObserver")," can be used to create and/or watch a query:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"const observer = new QueryObserver(queryClient, { queryKey: 'posts' })\n\nconst unsubscribe = observer.subscribe(result => {\n  console.log(result)\n  unsubscribe()\n})\n")),Object(o.b)("h4",{id:"infinitequeryobserver"},"InfiniteQueryObserver"),Object(o.b)("p",null,"A ",Object(o.b)("inlineCode",{parentName:"p"},"InfiniteQueryObserver")," can be used to create and/or watch an infinite query:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"const observer = new InfiniteQueryObserver(queryClient, {\n  queryKey: 'posts',\n  queryFn: fetchPosts,\n  getNextPageParam: (lastPage, allPages) => lastPage.nextCursor,\n  getPreviousPageParam: (firstPage, allPages) => firstPage.prevCursor,\n})\n\nconst unsubscribe = observer.subscribe(result => {\n  console.log(result)\n  unsubscribe()\n})\n")),Object(o.b)("h4",{id:"queriesobserver"},"QueriesObserver"),Object(o.b)("p",null,"A ",Object(o.b)("inlineCode",{parentName:"p"},"QueriesObserver")," can be used to create and/or watch multiple queries:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"const observer = new QueriesObserver(queryClient, [\n  { queryKey: ['post', 1], queryFn: fetchPost },\n  { queryKey: ['post', 2], queryFn: fetchPost },\n])\n\nconst unsubscribe = observer.subscribe(result => {\n  console.log(result)\n  unsubscribe()\n})\n")),Object(o.b)("h4",{id:"set-default-options-for-specific-queries"},"Set default options for specific queries"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"QueryClient.setQueryDefaults()")," method can be used to set default options for specific queries:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"queryClient.setQueryDefaults('posts', { queryFn: fetchPosts })\n\nfunction Component() {\n  const { data } = useQuery('posts')\n}\n")),Object(o.b)("h4",{id:"set-default-options-for-specific-mutations"},"Set default options for specific mutations"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"QueryClient.setMutationDefaults()")," method can be used to set default options for specific mutations:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"queryClient.setMutationDefaults('addPost', { mutationFn: addPost })\n\nfunction Component() {\n  const { mutate } = useMutation('addPost')\n}\n")),Object(o.b)("h4",{id:"useisfetching"},"useIsFetching()"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"useIsFetching()")," hook now accepts filters which can be used to for example only show a spinner for certain type of queries:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"const fetches = useIsFetching(['posts'])\n")),Object(o.b)("h4",{id:"core-separation"},"Core separation"),Object(o.b)("p",null,"The core of React Query is now fully separated from React, which means it can also be used standalone or in other frameworks. Use the ",Object(o.b)("inlineCode",{parentName:"p"},"react-query/core")," entrypoint to only import the core functionality:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"import { QueryClient } from 'react-query/core'\n")),Object(o.b)("h3",{id:"devtools-are-now-part-of-the-main-repo-and-npm-package"},"Devtools are now part of the main repo and npm package"),Object(o.b)("p",null,"The devtools are now included in the ",Object(o.b)("inlineCode",{parentName:"p"},"react-query")," package itself under the import ",Object(o.b)("inlineCode",{parentName:"p"},"react-query/devtools"),". Simply replace ",Object(o.b)("inlineCode",{parentName:"p"},"react-query-devtools")," imports with ",Object(o.b)("inlineCode",{parentName:"p"},"react-query/devtools")))}l.isMDXComponent=!0},142:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return h}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var u=r.a.createContext({}),l=function(e){var t=r.a.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},b=function(e){var t=l(e.components);return r.a.createElement(u.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},p=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),b=l(n),p=a,h=b["".concat(i,".").concat(p)]||b[p]||d[p]||o;return n?r.a.createElement(h,c(c({ref:t},u),{},{components:n})):r.a.createElement(h,c({ref:t},u))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=p;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:a,i[1]=c;for(var u=2;u<o;u++)i[u]=n[u];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,n)}p.displayName="MDXCreateElement"}}]);